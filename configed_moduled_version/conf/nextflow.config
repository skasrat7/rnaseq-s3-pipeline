// Main Nextflow configuration file
// Updated for ERCC spike-in analysis with nf-core/rnaseq and STAR-Fusion support

// Include additional configuration files
includeConfig 'conf/base.config'
includeConfig 'conf/rnaseq.config'

// Global parameters
params {
    // Input/Output
    input                     = 'samplesheet.csv'  // Update with your CSV file
    outdir                    = 'XXX'  // Update with your S3 path
    ref_dir                   = './references'    // Update with your references folder
    // Reference genome configuration
    genome                    = null  // We'll use custom references
    fasta                     = "${params.ref_dir}/GRCh38_ERCC_combined.fa"
    gtf                       = "${params.ref_dir}/GRCh38_ERCC_combined.gtf"

    // Reference paths
    s3_genome_dir             = 'XXX'  // Update with your S3 path

    // Reference file names
    genome_fasta              = 'Homo_sapiens.GRCh38.dna.primary_assembly.fa'
    genome_gtf                = 'Homo_sapiens.GRCh38.110.gtf'
    ercc_fasta                = 'ERCC92.fa'
    ercc_gtf                  = 'ERCC_biotypes.gtf'
    combined_fasta            = 'GRCh38_ERCC_combined.fa'
    combined_gtf              = 'GRCh38_ERCC_combined.gtf'

    // STAR-Fusion configuration
    enable_star_fusion        = true
    star_fusion_ctat_lib      = '/path/to/CTAT_resource_lib'  // Update with actual path

    // STAR chimeric options for fusion detection
    star_chimeric_min_seg     = 12
    star_chimeric_min_overhang = 8
    star_chimeric_filter_min_fusion_length = 200

    // Resource limits (will be overridden by profiles)
    max_cpus                  = 8
    max_memory                = '256.GB'
    max_time                  = '24.h'

    // AWS configuration
    aws_region                = 'us-east-2'  // Update as needed
}

// Process configuration
process {
    // Default container (pinned version for reproducibility)
    container = 'nfcore/rnaseq:3.21.0'

    // Default executor (overridden by profiles)
    executor = 'local'

    // STAR-specific configuration for chimeric junction detection

 withName: 'NFCORE_RNASEQ:RNASEQ:ALIGN_STAR:STAR_ALIGN' {
        ext.args = [
            '--chimSegmentMin ${params.star_chimeric_min_seg}',
            '--chimJunctionOverhangMin ${params.star_chimeric_min_overhang}',
            '--chimOutType Junctions SeparateSAMold',
            '--chimSegmentReadGapMax 3',
            '--chimScoreMin 1',
            '--chimScoreDropMax 30',
            '--chimScoreJunctionNonGTAG 0',
            '--chimScoreSeparation 1',
            '--alignSJstitchMismatchNmax 5 -1 5 5',
            '--chimMultimapScoreRange 10',
            '--chimNonchimScoreDropMin 10',
            '--peOverlapNbasesMin 12',
            '--peOverlapMMp 0.1',
            '--chimFilterType BySJout'
        ].join(' ')
    }

    // STAR-Fusion specific configuration
    withName: 'STAR_FUSION' {
        cpus = 8
        memory = '32.GB'
        time = '4.h'
        container = 'trinityctat/starfusion:1.12.0'
    }
}

// Container configuration
singularity {
    enabled = true
    autoMounts = true
    cacheDir = './singularity_cache'
    pullTimeout = '20 min'  // Longer timeout for large containers
}

docker {
    enabled = false  // Set to true if using Docker instead
}

// AWS configuration
aws {
    region = params.aws_region
    batch {
        cliPath = '/usr/local/aws-cli/v2/current/bin/aws'
    }
}

// Workflow configuration
workflow {
    // Enable resume by default
    resume = true
}

// Profiles for different execution environments
profiles {
    local {
        includeConfig 'conf/local.config'
    }

    aws {
        includeConfig 'conf/aws.config'
    }

    test {
        includeConfig 'conf/test.config'
    }
}

// Reporting configuration
report {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_report.html"
}

timeline {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_timeline.html"
}

trace {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_trace.txt"
}

dag {
    enabled = true
    file = "${params.outdir}/pipeline_info/pipeline_dag.html"
}

manifest {
    name = 'ERCC RNA-seq Analysis with Fusion Detection'
    author = 'Kasra Tabatabaei'
    description = 'nf-core/rnaseq pipeline with ERCC spike-ins and STAR-Fusion'
    version = '1.0.0'
    nextflowVersion = '>=23.04.0'
}
